name: Direct Merge to Main (Simple & Fast)

# Trigger when a push happens to AI branches
on:
  push:
    branches:
      - 'claude/**'
      - 'codex/**'
      - 'antigravity/**'

permissions:
  contents: write

jobs:
  direct-merge:
    name: Merge to Main Branch
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ·ï¸ Get Branch Info
        id: branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          AI_TYPE=$(echo $BRANCH_NAME | cut -d'/' -f1)
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ai=$AI_TYPE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Branch: $BRANCH_NAME"
          echo "ğŸ¤– AI Type: $AI_TYPE"

      - name: ğŸ” Check for Conflicts
        id: check
        run: |
          git fetch origin main
          git checkout main

          # Try to merge (dry-run)
          if git merge --no-commit --no-ff origin/${{ steps.branch.outputs.name }}; then
            echo "âœ… No conflicts detected"
            git merge --abort 2>/dev/null || true
            echo "can_merge=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Conflicts detected"
            git merge --abort 2>/dev/null || true
            echo "can_merge=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”€ Merge to Main
        if: steps.check.outputs.can_merge == 'true'
        run: |
          git checkout main
          git merge --no-ff origin/${{ steps.branch.outputs.name }} -m "ğŸ¤– Auto-merge from ${{ steps.branch.outputs.ai }}: ${{ steps.branch.outputs.name }}"
          git push origin main
          echo "âœ… Successfully merged to main!"

      - name: ğŸ—‘ï¸ Delete Feature Branch (Optional)
        if: steps.check.outputs.can_merge == 'true'
        run: |
          git push origin --delete ${{ steps.branch.outputs.name }} || echo "âš ï¸ Could not delete branch (may be protected)"

      - name: ğŸ‰ Success Notification
        if: steps.check.outputs.can_merge == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… MERGE SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¤– AI: ${{ steps.branch.outputs.ai }}"
          echo "ğŸ“ Branch: ${{ steps.branch.outputs.name }}"
          echo "ğŸš€ GitHub Pages deploying..."
          echo "â±ï¸  Website will update in 1-2 minutes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âŒ Conflict Notification
        if: steps.check.outputs.can_merge == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ MERGE FAILED - CONFLICTS DETECTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¤– AI: ${{ steps.branch.outputs.ai }}"
          echo "ğŸ“ Branch: ${{ steps.branch.outputs.name }}"
          echo ""
          echo "ğŸ”§ ACTION REQUIRED:"
          echo "1. Pull latest main branch"
          echo "2. Resolve conflicts manually"
          echo "3. Push again to retry"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
