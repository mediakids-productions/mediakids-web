name: Auto-Merge and Deploy to GitHub Pages

# Trigger when a push happens to branches starting with claude/, codex/, or antigravity/
on:
  push:
    branches:
      - 'claude/**'
      - 'codex/**'
      - 'antigravity/**'

# Required permissions
permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  auto-merge:
    name: Auto-Merge to Main
    runs-on: ubuntu-latest
    # Skip auto-merge for preview branches
    if: ${{ !contains(github.ref, 'preview') }}

    steps:
      # Step 1: Checkout the code
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Configure Git
      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Step 3: Get current branch name
      - name: ğŸ·ï¸ Get Branch Name
        id: branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Current branch: $BRANCH_NAME"

      # Step 4: Create or update Pull Request
      - name: ğŸ”€ Create/Update Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          base: main
          title: "ğŸ¤– Auto-merge: ${{ steps.branch.outputs.name }}"
          body: |
            ## ğŸ¤– Automatic Pull Request

            This PR was automatically created from branch `${{ steps.branch.outputs.name }}`

            ### ğŸ“ Changes
            - Auto-generated by AI assistant
            - Branch: `${{ steps.branch.outputs.name }}`
            - Commit: `${{ github.sha }}`

            ### âœ… Auto-Merge
            This PR will be automatically merged if all checks pass.

            ---
            ğŸ¤– Generated by GitHub Actions
          labels: |
            auto-merge
            ai-generated

      # Step 5: Auto-approve the PR (if needed)
      - name: âœ… Auto-approve Pull Request
        if: steps.pr.outputs.pull-request-number
        run: |
          gh pr review ${{ steps.pr.outputs.pull-request-number }} --approve --body "âœ… Auto-approved by GitHub Actions"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 6: Merge the Pull Request
      - name: ğŸ”€ Merge Pull Request
        if: steps.pr.outputs.pull-request-number
        run: |
          echo "â³ Waiting for checks to complete..."
          sleep 5

          echo "ğŸ”€ Merging PR #${{ steps.pr.outputs.pull-request-number }}..."
          gh pr merge ${{ steps.pr.outputs.pull-request-number }} \
            --auto \
            --squash \
            --delete-branch \
            --body "ğŸ¤– Auto-merged by GitHub Actions"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 7: Notify success
      - name: ğŸ‰ Merge Complete
        if: success()
        run: |
          echo "âœ… Successfully merged ${{ steps.branch.outputs.name }} into main!"
          echo "ğŸš€ GitHub Pages will deploy automatically in 1-2 minutes."

      # Step 8: Handle errors
      - name: âŒ Merge Failed
        if: failure()
        run: |
          echo "âŒ Failed to merge ${{ steps.branch.outputs.name }}"
          echo "ğŸ” Please check for conflicts or errors manually."
          exit 1
